exports.WidgetPartenaireCDI=void 0;const ObjetChaine_1=require("ObjetChaine");const Enumere_EvenementObjetSaisie_1=require("Enumere_EvenementObjetSaisie");const ObjetDate_1=require("ObjetDate");const ObjetFenetre_1=require("ObjetFenetre");const ObjetFiche_1=require("ObjetFiche");const ObjetIdentite_1=require("ObjetIdentite");const ObjetSaisie_1=require("ObjetSaisie");const ObjetTraduction_1=require("ObjetTraduction");const UtilitaireWidget_1=require("UtilitaireWidget");const TypeGenrePret_1=require("TypeGenrePret");const UtilitairePartenaire_1=require("UtilitairePartenaire");const ToucheClavier_1=require("ToucheClavier");const ObjetWidget_1=require("ObjetWidget");const ObjetListeElements_1=require("ObjetListeElements");const Divers_css_1=;const Widgets_dashboard_css_1=;const Type_ThemeBouton_1=require("Type_ThemeBouton");class WidgetPartenaireCDI extends ObjetWidget_1.Widget.ObjetWidget{constructor(){super(...arguments);this.textRecherche='';this.listeEmprunte=new ObjetListeElements_1.ObjetListeElements();this.listeHisto=new ObjetListeElements_1.ObjetListeElements();} creerObjetstPartenaireCDI(){this.comboCDI=ObjetIdentite_1.Identite.creerInstance(ObjetSaisie_1.ObjetSaisie,{pere:this,evenement:this._evenementSurComboCDI});this._initialiserComboCDI(this.comboCDI);this.ficheHistorique=ObjetFenetre_1.ObjetFenetre.creerInstanceFenetre(ObjetFiche_1.ObjetFiche,{pere:this,initialiser:false});this.ficheHistorique.destructionSurFermeture=false;} initialiserObjetsPartenaireCDI(){var _a;this.comboCDI.initialiser();this.comboCDI.setDonnees(this.donnees.listeCDI,0);const lVisible=((_a=this.donnees.listeCDI)===null||_a===void 0?void 0:_a.count())>1;this.comboCDI.setVisible(lVisible);this.ficheHistorique.initialiser();} surLienExterne(aCDI){if(aCDI.avecDelegationAuth){UtilitairePartenaire_1.TUtilitairePartenaire.ouvrirURLPartenaireCDI(aCDI);} else{UtilitairePartenaire_1.TUtilitairePartenaire.ouvrirUrl(aCDI.url,true);}} infosURLExterne(){let lCDI=this.CDI;if(!lCDI&&this.donnees.listeCDI&&this.donnees.listeCDI.count()>0){lCDI=this.donnees.listeCDI.get(0);} if(!!lCDI&&!!lCDI.url){return{callbackLien:this.surLienExterne.bind(this,lCDI),libelle:ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.lienExterne'),titre:ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.lienExterneInfobulle',[lCDI.getLibelle()])};} return undefined;} construire(aParams){var _a;this.donnees=aParams.donnees;this.creerObjetstPartenaireCDI();let lCDIParDefaut=null;if(this.donnees.listeCDI&&this.donnees.listeCDI.count()>0){lCDIParDefaut=this.donnees.listeCDI.get(0);} const lTitre=((_a=this.donnees.listeCDI)===null||_a===void 0?void 0:_a.count())===1?lCDIParDefaut.getLibelle():ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.titre');const lWidget={getHtml:this.composeWidgetPartenaireCDI.bind(this,lCDIParDefaut),listeElementsGraphiques:[{id:this.comboCDI.getNom()} ],titre:lTitre,nbrElements:null,afficherMessage:false,avecActualisation:true,infosURLExterne:this.infosURLExterne.bind(this),fermerFiches:() =>{this.ficheHistorique.fermer();}};$.extend(true,this.donnees,lWidget);this.idInputRecherche=this.Nom+'_inputSearch';aParams.construireWidget(this.donnees);this.initialiserObjetsPartenaireCDI();} getControleur(aInstance){return $.extend(true,super.getControleur(aInstance),{nodePartenaireCDI(){$(this.node).eventValidation((e) =>{aInstance._surPartenaireCDI();});},nodeSurRechercheCDI(){$(this.node).eventValidation((e) =>{aInstance._surRechercheCDI();});}});} actualiserPartenaireCDI(aCDI){var _a;this.CDI=aCDI;const lTitre=((_a=this.donnees.listeCDI)===null||_a===void 0?void 0:_a.count())===1?aCDI.getLibelle():ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.titre');const lWidget={getHtml:this.composeWidgetPartenaireCDI.bind(this,aCDI),nbrElements:null,afficherMessage:false,titre:lTitre,infosURLExterne:this.infosURLExterne.bind(this),avecActualisation:!!aCDI.avecActualisation};$.extend(true,this.donnees,lWidget);UtilitaireWidget_1.UtilitaireWidget.actualiserWidget(this);} composeWidgetPartenaireCDI(aCDI){const H=[];this.donneesRequete.partenaireCDI.CDI=aCDI;if(aCDI&&aCDI.listePrets&&aCDI.listePrets.count()>0){this.listeEmprunte=aCDI.listePrets.getListeElements(aPret =>[TypeGenrePret_1.TypeGenrePret.GP_EnCours,TypeGenrePret_1.TypeGenrePret.GP_EnRetard].includes(aPret.getGenre()));this.listeHisto=aCDI.listePrets.getListeElements(aPret =>[TypeGenrePret_1.TypeGenrePret.GP_Historique].includes(aPret.getGenre()));} else{this.listeEmprunte=new ObjetListeElements_1.ObjetListeElements();this.listeHisto=new ObjetListeElements_1.ObjetListeElements();} const lMap={keyup:(aEvent) =>{if(aEvent.which===ToucheClavier_1.ToucheClavier.RetourChariot){this._surRechercheCDI();}}};H.push(IE.jsx.str("div",{class:[Divers_css_1.StylesDivers.mLeftXl,Divers_css_1.StylesDivers.mRightXl,Divers_css_1.StylesDivers.mBottomXl,Divers_css_1.StylesDivers.fieldContain,Divers_css_1.StylesDivers.cols,Divers_css_1.StylesDivers.flexStart]},IE.jsx.str("label",{for:this.idInputRecherche,class:[Divers_css_1.StylesDivers.mBottom]},ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.rechercher')),IE.jsx.str("div",{class:[Divers_css_1.StylesDivers.flexContain,Divers_css_1.StylesDivers.fullWidth,Divers_css_1.StylesDivers.flexCenter]},IE.jsx.str("input",{id:this.idInputRecherche,name:this.idInputRecherche,"ie-model":this.jsxInputRecherche.bind(this),"ie-eventmap":lMap,class:[Divers_css_1.StylesDivers.fluidBloc],type:"text",placeholder:ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.recherche')}),IE.jsx.str("ie-btnicon",{"ie-model":this.jsxBoutonRecherche.bind(this),class:[Divers_css_1.StylesDivers.fixBloc,'bt-activable','icon_search',Divers_css_1.StylesDivers.mLeft]}))));if(this.listeEmprunte.count()>0){H.push(IE.jsx.str("div",{class:[Divers_css_1.StylesDivers.mLeftXl,Divers_css_1.StylesDivers.mRightXl,Divers_css_1.StylesDivers.semiBold]},ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.empruntsEnCours',this.listeEmprunte.count())));H.push(this.composeListePrets(this.listeEmprunte,false));} else{H.push(IE.jsx.str("div",{class:[Divers_css_1.StylesDivers.mAllXl]},ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.aucunEmprunt')));} if(this.listeHisto.count()>0){H.push(IE.jsx.str("div",{class:[Divers_css_1.StylesDivers.mAllL,Divers_css_1.StylesDivers.pBottomXl,Divers_css_1.StylesDivers.flexContain,Divers_css_1.StylesDivers.justifyEnd]},IE.jsx.str("ie-bouton",{"ie-model":this.jsxModeleBoutonHistorique.bind(this),"ie-icon":"icon_eye_open",class:[Type_ThemeBouton_1.TypeThemeBouton.secondaire],"ie-tooltiplabel":ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.voirHistorique')},ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.boutonhistorique'))));} return H.join('');} jsxBoutonRecherche(){return{event:() =>{this._surRechercheCDI();},getTitle:() =>{return ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.rechercher');},getDisabled:() =>{return this.textRecherche==='';}};} jsxInputRecherche(){return{getValue:() =>{return this.textRecherche;},setValue:(aValue) =>{this.textRecherche=aValue;},getDisabled:() =>{return false;}};} jsxModeleBoutonHistorique(){return{event:() =>{this._surHistorique();}};} composeListePrets(aListePret,aPourHistorique){const H=[];if(aListePret.count()>0){if(aPourHistorique){H.push('<div class="partenairecdi" style="min-width: 38rem;">');} H.push('<dl>');for(let i=0;i<aListePret.count();i++){const lPret=aListePret.get(i);const lEnretard=lPret.getGenre()===TypeGenrePret_1.TypeGenrePret.GP_EnRetard;const lLibelleRendu=aPourHistorique?ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.renduLe'):ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.aRendreLe');const lDateRetour=aPourHistorique?lPret.dateRetourEffectif:lPret.dateRetourPrevue;H.push(IE.jsx.str(IE.jsx.fragment,null,IE.jsx.str("dt",null,lPret.url&&IE.jsx.str("a",{href:ObjetChaine_1.GChaine.verifierURLHttp(lPret.url),target:"_blank",class:[Widgets_dashboard_css_1.StylesWidgetsDashboard.wrapperLink,Divers_css_1.StylesDivers.linkIconAfter,Divers_css_1.StylesDivers.withUnderline],"ie-tooltiplabel":lPret.commentaire},lPret.titre)||IE.jsx.str("span",{"ie-tooltiplabel":lPret.commentaire},lPret.titre)),IE.jsx.str("dd",{class:[Divers_css_1.StylesDivers.flexContain,Divers_css_1.StylesDivers.justifyBetween]},IE.jsx.str("span",null,ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.emprunteLe')," : ",ObjetDate_1.GDate.formatDate(lPret.dateEmprunt,'[%JJ/%MM/%AA]')),IE.jsx.str("span",{class:[Divers_css_1.StylesDivers.flexContain]},IE.jsx.str("span",{class:[Divers_css_1.StylesDivers.fluidBloc,Divers_css_1.StylesDivers.mRight]},lLibelleRendu," : ",ObjetDate_1.GDate.formatDate(lDateRetour,'[%JJ/%MM/%AA]')),IE.jsx.str("span",{style:"width: 1.6rem","ie-tooltiplabel":lEnretard&&ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.dateRenduDepassee'),class:lEnretard&&[Divers_css_1.StylesDivers.fixBloc,Widgets_dashboard_css_1.StylesWidgetsDashboard.dateAlert]||Divers_css_1.StylesDivers.fixBloc})))));} H.push('</dl>');if(aPourHistorique){H.push('</div>');}} return H.join('');} composeListePretsOld(aCDI,aPourHistorique){const H=[];if(!!aCDI.listePrets&&aCDI.listePrets.count()){H.push('<table class="is-clickable">');H.push(IE.jsx.str(IE.jsx.fragment,null,IE.jsx.str("thead",null,IE.jsx.str("tr",null,IE.jsx.str("th",{scope:"col"},ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.ressourcesEmpruntees')),IE.jsx.str("th",{scope:"col"},ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.emprunteLe')),IE.jsx.str("th",{scope:"col"},aPourHistorique?ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.renduLe'):ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.aRendreLe'))))));for(let i=0;i<aCDI.listePrets.count();i++){const lPret=aCDI.listePrets.get(i);const lAfficher=aPourHistorique?(lPret.getGenre()===TypeGenrePret_1.TypeGenrePret.GP_Historique):(lPret.getGenre()===TypeGenrePret_1.TypeGenrePret.GP_EnCours)||(lPret.getGenre()===TypeGenrePret_1.TypeGenrePret.GP_EnRetard);if(lAfficher){H.push('<tr>','<td>','<a href="',ObjetChaine_1.GChaine.verifierURLHttp(lPret.url),'" target="_blank" class=LienAccueil"',(lPret.commentaire?' ie-hint="'+lPret.commentaire+'"':''),'>',lPret.titre,'</a>','</td>','<td>',ObjetDate_1.GDate.formatDate(lPret.dateEmprunt,'[%JJ/%MM/%AA]'),'</td>','<td',lPret.getGenre()===TypeGenrePret_1.TypeGenrePret.GP_EnRetard?' class="date-alert" ie-hint="'+ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.dateRenduDepassee')+'"':'','>',ObjetDate_1.GDate.formatDate(aPourHistorique?lPret.dateRetourEffectif:lPret.dateRetourPrevue,'[%JJ/%MM/%AA]'),'</td>','</tr>');}} H.push('</table>');} return H.join('');} _surHistorique(){this.ficheHistorique.setOptionsFenetre({titre:ObjetTraduction_1.GTraductions.getValeur('accueil.CDI.historique'),largeurMin:300,htmlContenu:this.composeListePrets(this.listeHisto,true)});this.ficheHistorique.afficher();} _onKeyPress(aEvent){if(aEvent.keyCode===ToucheClavier_1.ToucheClavier.RetourChariot){this._surRechercheCDI();}} _surRechercheCDI(){let lValeurRecherchee=this.textRecherche.trim();if(!!lValeurRecherchee&&lValeurRecherchee.length>0){UtilitairePartenaire_1.TUtilitairePartenaire.ouvrirURLPartenaireRecherche(this.donneesRequete.partenaireCDI.CDI,lValeurRecherchee);}} _initialiserComboCDI(aObjet){aObjet.setOptionsObjetSaisie({longueur:80,avecBoutonsPrecSuiv:false,avecBoutonsPrecSuivVisiblesInactifs:false,labelWAICellule:ObjetTraduction_1.GTraductions.getValeur('WAI.SelectionPortail')});} _evenementSurComboCDI(aParams){if(aParams.genreEvenement===Enumere_EvenementObjetSaisie_1.EGenreEvenementObjetSaisie.selection){this.actualiserPartenaireCDI(aParams.element);}} _surPartenaireCDI(){UtilitairePartenaire_1.TUtilitairePartenaire.ouvrirURLPartenaireCDI(this.CDI);}} exports.WidgetPartenaireCDI=WidgetPartenaireCDI;